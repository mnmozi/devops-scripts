worker_processes auto;
pid /etc/nginx/run/nginx.pid;
worker_rlimit_nofile 1048576;
load_module modules/ngx_rtmp_module.so;

events {
  worker_connections 1048576;
  multi_accept on;
  use epoll;
}

rtmp {
  server {
    listen 1935; # Listen on standard RTMP port
    chunk_size 4096;
    interleave on;
    wait_key on;

    allow publish all;

    application horizontal_main {
      live on;

      # Turn on HLS
      hls on;
      hls_path /mnt/horizontal_main/;
      hls_fragment 3s;
      hls_playlist_length 27s;

      interleave on;
      wait_key on;
      wait_video on;

      hls_fragment_naming system;
      hls_fragment_naming_granularity 500;
      hls_fragment_slicing aligned;

      hls_type live;
      hls_sync 200ms;
      hls_continuous on;

      # disable consuming the stream from nginx as rtmp
      allow publish all;

      # Instruct clients to adjust resolution according to bandwidth
      hls_variant _240 BANDWIDTH=500000 AVERAGE-BANDWIDTH=400000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=428x240 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # Low 240 bitrate, sub-SD resolution
      hls_variant _360 BANDWIDTH=800000 AVERAGE-BANDWIDTH=600000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=640x360 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # Low 360 bitrate, sub-SD resolution
      hls_variant _480 BANDWIDTH=1500000 AVERAGE-BANDWIDTH=1000000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=854x480 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # Mid 480 bitrate, higher-than-SD resolution
      hls_variant _720 BANDWIDTH=3500000 AVERAGE-BANDWIDTH=2000000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=1280x720 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # High bitrate, HD 720p resolution
      hls_variant _1080 BANDWIDTH=2500000 AVERAGE-BANDWIDTH=2500000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=1920x1080 FRAME-RATE=25.000 CLOSED-CAPTIONS=NONE; # Source bitrate, source

      allow play all;
    }

    application vertical_main {
      live on;
      hls on;
      hls_path /mnt/vertical_main/;
      hls_fragment 3s; ## old one 7sec
      hls_playlist_length 27s;

      interleave on;
      wait_key on;
      wait_video on;

      hls_fragment_naming system;
      hls_fragment_naming_granularity 500;
      hls_fragment_slicing aligned;

      hls_type live;
      hls_sync 200ms;
      hls_continuous on;

      # disable consuming the stream from nginx as rtmp
      allow publish all;

      # Instruct clients to adjust resolution according to bandwidth
      hls_variant _480 BANDWIDTH=1500000 AVERAGE-BANDWIDTH=1000000 CODECS="avc1.640033,mp4a.40.2" RESOLUTION=480x854 FRAME-RATE=25.000 CLOSED-CAPTIONS=NONE; # Mid 480 bitrate, higher-than-SD resolution
      hls_variant _720 BANDWIDTH=3000000 AVERAGE-BANDWIDTH=2000000 CODECS="avc1.640033,mp4a.40.2" RESOLUTION=720x1280 FRAME-RATE=25.000 CLOSED-CAPTIONS=NONE; # High bitrate, HD 720p resolution
      hls_variant _1080 BANDWIDTH=4500000 AVERAGE-BANDWIDTH=3000000 CODECS="avc1.640033,mp4a.40.2" RESOLUTION=1080x1920 FRAME-RATE=25.000 CLOSED-CAPTIONS=NONE; # Source bitrate, source

      allow play all;
    }

    application ott {
      live on;
      hls on;
      hls_path /mnt/ott/;
      hls_fragment 3; ## old one 7sec
      hls_playlist_length 27s;

      interleave on;
      wait_key on;
      wait_video on;

      hls_fragment_naming system;
      hls_fragment_naming_granularity 500;
      hls_fragment_slicing aligned;

      hls_type live;
      hls_sync 200ms;
      hls_continuous on;

      # disable consuming the stream from nginx as rtmp
      allow publish all;

      # Instruct clients to adjust resolution according to bandwidth
      hls_variant _240 BANDWIDTH=500000 AVERAGE-BANDWIDTH=400000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=428x240 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # Low 240 bitrate, sub-SD resolution
      hls_variant _360 BANDWIDTH=800000 AVERAGE-BANDWIDTH=600000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=640x360 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # Low 360 bitrate, sub-SD resolution
      hls_variant _480 BANDWIDTH=1500000 AVERAGE-BANDWIDTH=1000000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=854x480 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # Mid 480 bitrate, higher-than-SD resolution
      hls_variant _720 BANDWIDTH=3500000 AVERAGE-BANDWIDTH=2000000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=1280x720 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # High bitrate, HD 720p resolution
      hls_variant _1080 BANDWIDTH=5000000 AVERAGE-BANDWIDTH=3000000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=1920x1080 FRAME-RATE=30.000 CLOSED-CAPTIONS=NONE; # Source bitrate, source

      allow play all;
    }

    application radio {
      live on;
      # Turn on HLS
      hls on;
      hls_path /mnt/radio/;
      hls_fragment 3;
      hls_playlist_length 7s;

      interleave on;
      wait_key on;
      wait_video on;

      hls_fragment_naming system;
      hls_fragment_naming_granularity 500;
      hls_fragment_slicing aligned;

      hls_type live;
      hls_sync 200ms;
      hls_continuous on;

      # disable consuming the stream from nginx as rtmp
      allow publish all;

      # Instruct clients to adjust resolution according to bandwidth

      # hls_variant _240  BANDWIDTH=500000   AVERAGE-BANDWIDTH=400000  CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=428x240  FRAME-RATE=30.000  CLOSED-CAPTIONS=NONE; # Low 240 bitrate, sub-SD resolution
      # hls_variant _360  BANDWIDTH=800000   AVERAGE-BANDWIDTH=600000  CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=640x360  FRAME-RATE=30.000  CLOSED-CAPTIONS=NONE; # Low 360 bitrate, sub-SD resolution
      # hls_variant _480  BANDWIDTH=1500000   AVERAGE-BANDWIDTH=1000000  CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=854x480  FRAME-RATE=30.000  CLOSED-CAPTIONS=NONE; # Mid 480 bitrate, higher-than-SD resolution
      # hls_variant _720  BANDWIDTH=3500000  AVERAGE-BANDWIDTH=2000000 CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=1280x720 FRAME-RATE=30.000  CLOSED-CAPTIONS=NONE; # High bitrate, HD 720p resolution
      # hls_variant _1080 BANDWIDTH=2500000  AVERAGE-BANDWIDTH=2500000  CODECS="avc1.66.30,mp4a.40.2" RESOLUTION=1920x1080  FRAME-RATE=25.000  CLOSED-CAPTIONS=NONE; # Source bitrate, source
      allow play all;
    }


  }

}


http {

  # It may appear that tcp_nopush and tcp_nodelay are mutually exclusive. But if all 3 directives are turned on, nginx will:
  # ensure packages are full before sending them to the client
  # for the last packet, tcp_nopush will be removed, allowing TCP to send it immediately, without the 200ms delay
  sendfile off;
  tcp_nopush on;
  tcp_nodelay on;

  aio on;
  directio 512;
  large_client_header_buffers 4 16k;

  server_tokens off;
  keepalive_timeout 60s;
  types_hash_max_size 2048;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  # logs
  real_ip_header X-Forwarded-For;
  set_real_ip_from 172.21.0.0/16;
  real_ip_recursive on;

  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
  '$status $body_bytes_sent "$http_referer" '
  '"$http_user_agent" "$http_x_forwarded_for"';

  map $http_user_agent $ignore_ua {
    default 1;
    "ELB-HealthChecker/2.0" 0;
  }

  access_log /var/log/nginx/access.log main if=$ignore_ua;
  error_log /var/log/nginx/error.log;

  # gzip
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_buffers 16 8k;
  gzip_disable "msie6";
  gzip_http_version 1.1;
  gzip_comp_level 6;
  gzip_types text/plain text/css application/json application/javascript text/javascript application/x-javascript text/xml application/xml application/xml+rss application/vnd.ms-fontobject application/x-font-ttf font/opentype font/x-woff image/svg+xml image/x-icon application/vnd.apple.mpegurl video/mp2t image/png image/jpg image/jpeg image/gif;

  # ssl
  ssl_ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;
  #    ssl_session_timeout 10m;

  ssl_session_tickets off;
  ssl_stapling off;
  ssl_stapling_verify off;

  # proxy
  proxy_redirect off;
  proxy_http_version 1.1;
  proxy_read_timeout 30s;
  proxy_send_timeout 30s;
  proxy_connect_timeout 30s;
  send_timeout 30;

  proxy_cache_path /var/cache/nginx/HLS_origin_cache_temp use_temp_path=off keys_zone=HLS_origin_cache_temp:100m max_size=2g inactive=5m;
  proxy_cache_key $scheme$proxy_host$uri$is_args$args;

  proxy_cache HLS_origin_cache_temp;
  proxy_cache_methods GET HEAD;
  proxy_cache_valid 400 5s;
  proxy_cache_valid 403 30m;
  proxy_cache_valid 401 402 404 10s;
  proxy_cache_lock on;
  proxy_cache_lock_age 5s;
  proxy_cache_lock_timeout 1m;
  proxy_ignore_headers Set-Cookie;

  server {
    listen 8080;
    server_name nginx2.sna.com;

    # logs
    access_log /var/log/nginx/access_backend.log main if=$ignore_ua;
    error_log /var/log/nginx/error_backend.log ;

    location / {
      root /mnt/;
    }
  }

  # default route
  server {
    server_name nginx1.sna.com;

    listen 3080 ;
    listen 3443 default ssl;

    ssl_certificate /etc/nginx/ssl/sna-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/sna-selfsigned.key;

    add_header X-Cache-Status $upstream_cache_status;
    add_header X-Node Main_origin;

    etag off;

    location / {
      proxy_pass http://127.0.0.1:8080;
      add_header X-Cache-Status $upstream_cache_status;
      add_header X-Node Backup_origin;
      add_header Access-Control-Allow-Origin *;

      proxy_cache HLS_origin_cache_temp;
      proxy_cache_revalidate on;
      proxy_cache_min_uses 1;
      proxy_cache_lock on;

      proxy_cache_valid 400 5s;
      proxy_cache_valid 403 30m;
      proxy_cache_valid 401 402 404 10s;

      root /mnt/;
      allow all;

      etag off;

    }

    #### Cedexis Monitoring #####
    location ^~ /cdx {
      proxy_pass http://127.0.0.1:8080;
      add_header Cache-Control "public";
      add_header Access-Control-Allow-Origin *;
      add_header Timing-Allow-Origin: *;

      proxy_cache_valid 200 301 302 24h;
      proxy_cache_valid 400 5s;
      proxy_cache_valid 403 30m;
      proxy_cache_valid 401 402 404 30s;
      expires 1y;

      allow all;

      #Cache for status check
      location ~ \.(png|html|jpg/jpeg)$ {
        proxy_pass http://127.0.0.1:8080;
        expires 10s;
        add_header Cache-Control "public";
        allow all;
      }

    }
    location ^~ /status {

      location ~ \.(html)$ {
        etag off;
        add_header Cache-Control "private, no-cache, no-store";
        add_header X-Cache-Status $upstream_cache_status;
        add_header Access-Control-Allow-Origin *;
        add_header Timing-Allow-Origin *;
      }
      root /mnt/;
      allow all;
    }

    location ^~ /horizontal_main {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }
      location ~ \.(m3u8|mpd)$ {
        proxy_pass http://127.0.0.1:8080;

        add_header Cache-Control "public";
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Node Main_origin;
        add_header Access-Control-Allow-Origin *;
        add_header Timing-Allow-Origin *;

        etag off;
        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 10s;
        expires -1;

        ### case insensitive http user agent blocking ###
        if ($http_user_agent ~ "Xtream-Codes IPTV Panel Pro|Free-IPTV") {
          return 403;
        }
      }

      location ~ \.(ts)$ {
        proxy_pass http://127.0.0.1:8080;
        add_header Cache-Control "s-maxage=300" ;
        add_header Cache-Control "public";
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Node Main_origin;
        add_header Timing-Allow-Origin *;
        add_header Access-Control-Allow-Origin *;

        etag off;
        proxy_cache_valid 200 301 302 5m;
        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 30m;
        proxy_cache_valid 401 402 404 10s;
        expires 5m;

        ### case insensitive http user agent blocking ###
        if ($http_user_agent ~ "Xtream-Codes IPTV Panel Pro|Free-IPTV|Apache-HttpClient/UNAVAILABLE (java 1.4)") {
          return 403;
        }
      }

      proxy_pass http://127.0.0.1:8080;

      add_header X-Cache-Status $upstream_cache_status;
      add_header X-Node Main_origin;

      proxy_cache_valid 200 301 302 5s;
      proxy_cache_valid 400 5s;
      proxy_cache_valid 403 30m;
      proxy_cache_valid 401 402 404 10s;

      root /mnt/;
      allow all;
    }

    location ^~ /vertical_main {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }

      location ~ \.(m3u8|mpd)$ {
        proxy_pass http://127.0.0.1:8080;
        add_header X-Node Backup_origin;
        add_header Access-Control-Allow-Origin *;
        add_header Timing-Allow-Origin *;
        add_header Cache-Control "public";
        add_header X-Cache-Status $upstream_cache_status;
        etag off;

        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 10s;
        expires -1;

        ### case insensitive http user agent blocking ###
        if ($http_user_agent ~ "Xtream-Codes IPTV Panel Pro|Free-IPTV") {
          return 403;
        }

      }

      location ~ \.(ts)$ {
        proxy_pass http://127.0.0.1:8080;
        add_header X-Node Backup_origin;
        add_header Access-Control-Allow-Origin *;
        add_header Timing-Allow-Origin *;
        add_header Cache-Control "s-maxage=300" ;
        add_header Cache-Control "public";
        add_header X-Cache-Status $upstream_cache_status;

        etag off;
        proxy_cache_valid 200 301 302 5m;
        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 30m;
        proxy_cache_valid 401 402 404 10s;
        expires 5m;

        ### case insensitive http user agent blocking ###
        if ($http_user_agent ~ "Xtream-Codes IPTV Panel Pro|Free-IPTV" ) {
          return 403;
        }
      }

      proxy_pass http://127.0.0.1:8080;
      add_header X-Cache-Status $upstream_cache_status;
      add_header X-Node Backup_origin;

      proxy_cache_valid 200 301 302 5s;
      proxy_cache_valid 400 5s;
      proxy_cache_valid 403 30m;
      proxy_cache_valid 401 402 404 10s;

      root /mnt/;
      allow all;
    }

    location /radio {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Timing-Allow-Origin *;
      # Proxy settings for HLS files
      location ~* \.(m3u8|ts)$ {
        proxy_pass http://10.229.128.153;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Node Main_origin;
        add_header Access-Control-Allow-Origin *;
        add_header Timing-Allow-Origin *;
        add_header Cache-Control "public";


        etag off;
        proxy_cache_valid 200 5s;
        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 10s;
        expires -1;

        if ($http_user_agent ~* "Xtream-Codes IPTV Panel Pro|Free-IPTV|Apache-HttpClient/UNAVAILABLE (java 1.4)") {
          return 403;
        }
      }
    }

    location ^~ /ott {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }

      location ~ \.(m3u8|mpd)$ {
        proxy_pass http://127.0.0.1:8080;
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Node Backup_origin;
        add_header Access-Control-Allow-Origin *;
        add_header Timing-Allow-Origin *;
        add_header Cache-Control "public";

        etag off;
        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 10s;
        expires -1;

        ### case insensitive http user agent blocking ###
        if ($http_user_agent ~ "Xtream-Codes IPTV Panel Pro|Free-IPTV") {
          return 403;
        }
      }

      location ~ \.(ts)$ {
        proxy_pass http://127.0.0.1:8080;
        add_header X-Node Backup_origin;
        add_header Access-Control-Allow-Origin *;
        add_header Timing-Allow-Origin *;
        add_header Cache-Control "s-maxage=300" ;
        add_header Cache-Control "public";
        add_header X-Cache-Status $upstream_cache_status;

        etag off;
        proxy_cache_valid 200 301 302 5m;
        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 30m;
        proxy_cache_valid 401 402 404 10s;
        expires 5m;

        ### case insensitive http user agent blocking ###
        if ($http_user_agent ~ "Xtream-Codes IPTV Panel Pro|Free-IPTV" ) {
          return 403;
        }
      }

      proxy_pass http://127.0.0.1:8080;
      add_header X-Cache-Status $upstream_cache_status;
      add_header X-Node Backup_origin;

      proxy_cache_valid 200 301 302 5s;
      proxy_cache_valid 400 5s;
      proxy_cache_valid 403 30m;
      proxy_cache_valid 401 402 404 10s;

      root /mnt/;
      allow all;
    }

    location ^~ /live {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }
      location ~ \.(m3u8|mpd)$ {
        proxy_pass http://127.0.0.1:8080;
        add_header X-Node Main_origin;
        add_header Access-Control-Allow-Origin *;
        add_header Timing-Allow-Origin *;
        add_header Cache-Control "public";
        add_header X-Cache-Status $upstream_cache_status;

        etag off;

        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 10s;
        expires -1;

        ### case insensitive http user agent blocking ###
        if ($http_user_agent ~ "Xtream-Codes IPTV Panel Pro|Free-IPTV") {
          return 403;
        }
      }


      location ~ \.(ts)$ {
        proxy_pass http://127.0.0.1:8080;
        add_header X-Node Main_origin;
        add_header Timing-Allow-Origin *;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "s-maxage=300" ;
        add_header Cache-Control "public";
        add_header X-Cache-Status $upstream_cache_status;

        etag off;
        proxy_cache_valid 200 301 302 5m;
        proxy_cache_valid 400 5s;
        proxy_cache_valid 403 30m;
        proxy_cache_valid 401 402 404 10s;
        expires 5m;

        ### case insensitive http user agent blocking ###
        if ($http_user_agent ~ "Xtream-Codes IPTV Panel Pro|Free-IPTV|Apache-HttpClient/UNAVAILABLE (java 1.4)") {
          return 403;
        }

      }

      proxy_pass http://127.0.0.1:8080;
      add_header X-Cache-Status $upstream_cache_status;
      add_header X-Node Main_origin;

      proxy_cache_valid 200 301 302 5s;
      proxy_cache_valid 400 5s;
      proxy_cache_valid 403 30m;
      proxy_cache_valid 401 402 404 10s;

      root /mnt/;
      allow all;
    }

  }
}
